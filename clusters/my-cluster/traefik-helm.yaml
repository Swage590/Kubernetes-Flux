apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: traefik
  namespace: default
spec:
  interval: 30m
  url: https://traefik.github.io/charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: traefik
  namespace: default
spec:
  interval: 10m
  chart:
    spec:
      chart: traefik
      sourceRef:
        kind: HelmRepository
        name: traefik
  values:
    apiVersion: helm.cattle.io/v1
    kind: HelmChartConfig
    metadata:
      name: traefik

    commonLabels:
      app: traefik

    persistence:
      enabled: true
      path: /data
      size: 1Gi

    service:
      type: LoadBalancer
      loadBalancerIP: 10.59.20.70

    ports:
      web:
        redirections:
          entryPoint:
            to: websecure
            scheme: https
            permanent: true

    # ACME resolver using step-ca
    certificatesResolvers:
      step:
        acme:
          caServer: "https://data.swage:9000/acme/acme/directory"
          email: "admin@status.swage"
          storage: "/data/acme.json"
          tlsChallenge: true
      letsencrypt:
        acme:
          dnsChallenge:
            provider: cloudflare
            resolvers: ["1.1.1.1", "1.0.0.1"]
            # propagation:
            #   disableChecks: true
            #   delayBeforeChecks: 60
          storage: /data/acme.json
          email: "crazycreeper3@gmail.com"

    tls:
      certificates:
        - certResolver: letsencrypt
          domains:
            - main: "*.swages.net"
            - main: "*.swages.cloud"

    https:
      routers:
        error-router:
          rule: HostRegexp(`{host:.+}`)
          priority: 1
          middlewares: error-pages-middleware
          entrypoints: websecure
          tls:
            certResolver: letsencrypt
      middlewares:
        error-pages-middleware:
          errors:
            status: 400-599
            service: error-pages-service
            query: /{status}.html

    additionalVolumeMounts:
      - name: step-ca-certs
        mountPath: /etc/ssl/certs/root_ca.crt
        subPath: root_ca.crt
        readOnly: true

    deployment:
      additionalVolumes:
          - configMap:
              name: step-ca-cm
            name: step-ca-certs
      initContainers:
        - name: volume-permissions
          image: busybox:latest
          command: ["sh", "-c", "touch /data/acme.json; chmod -v 600 /data/acme.json"]
          volumeMounts:
          - mountPath: /data
            name: data
    podSecurityContext:
      fsGroup: 65532
      fsGroupChangePolicy: "OnRootMismatch"

    env:
      - name: CF_DNS_API_TOKEN
        valueFrom:
          secretKeyRef:
            name: cloudflare
            key: dns_edit
---
apiVersion: notification.toolkit.fluxcd.io/v1beta3
kind: Alert
metadata:
  name: helm-traefik
  namespace: flux-system
spec:
  providerRef:
    name: discord-flux-chan
  eventSeverity: info
  eventSources:
  - kind: HelmRepository
    name: traefik
  - kind: HelmChart
    name: default-traefik
  - kind: HelmRelease
    name: traefik
    namespace: default
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: default-404
  namespace: default
  annotations:
    kubernetes.io/ingress.class: traefik
    traefik.http.routers.error-router.rule: HostRegexp(`{host:.+}`)
    traefik.http.routers.error-router.priority: "1"
    traefik.http.routers.error-router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.tls.certresolver: letsencrypt

    traefik.http.routers.error-router.middlewares: error-pages-middleware

    traefik.http.middlewares.error-pages-middleware.errors.status: 400-599
    traefik.http.middlewares.error-pages-middleware.errors.service: error-pages-service
    traefik.http.middlewares.error-pages-middleware.errors.query: /{status}.html

    traefik.http.services.error-pages-service.loadbalancer.server.port: 80

spec:
  replicas: 1
  selector:
    matchLabels:
      app: default-404
  template:
    metadata:
      labels:
        app: default-404
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
          volumeMounts:
            - name: html
              mountPath: /usr/share/nginx/html
      volumes:
        - name: html
          configMap:
            name: default-404-page
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: default-404-page
  namespace: default
data:
  index.html: |
    <!DOCTYPE html>
    <html>
      <head><title>Not Found</title></head>
      <body><h1>404 - Not Found, maybe visit swages.net</h1></body>
    </html>
---
apiVersion: v1
kind: Service
metadata:
  name: default-404
  namespace: default
spec:
  selector:
    app: default-404
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: wildcard-catchall
  namespace: default
spec:
  entryPoints:
    - websecure
  routes:
    - match: HostRegexp(`{host:.+}`)
      kind: Rule
      services:
        - name: default-404
          port: 80
  tls:
    # Important: use the same resolver name as in your Helm values
    certResolver: letsencrypt
    domains:
      - main: "swages.net"
        sans:
          - "*.swages.net"
          - "*.swages.cloud"
